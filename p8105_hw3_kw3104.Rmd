---
title: "p8105_hw3_kw3104"
output: github_document
---
```{r}
library(tidyverse)
library(dplyr)
library(knitr)
library(ggplot2)
```

## Problem 2

Load, tidy and merge data sets:
```{r}
##load demography csv file, skip first 4 rows that contain non-related information, clean names.
## before sort, `demo` has 250 observations and 5 variables; after sort, `demo` has 228 observations and 5 variables.
demo = 
  read_csv("data/nhanes_covar.csv", skip = 4)|>
  janitor::clean_names() |>
  filter(age >=21) |>
  drop_na()

## load accelerometer csv file, clean names.
## `accel` has 250 observations and 1441 variables.
accel = 
  read_csv("data/nhanes_accel.csv")|>
  janitor::clean_names ()

## Use anti_join to check for completeness and correctness across datasets. `anti` shows 0 observation and 5 variables, means the all rows are matched.
anti = anti_join(demo, accel, by = "seqn")


## left join `demo` and `accel` files, combine them into `demo_accel` file based on seqn. `demo_accel` has 228 observations and 1445 variables
demo_accel = left_join (demo, accel, by = "seqn")

```

Table for the number of men and women in each education category
```{r}
## mutate `sex` and `education` from numerical variables into factor
sex_edu <- demo_accel|>
  mutate(
    sex = factor(sex, levels = c(1, 2), labels = c("male", "female")),
    education = factor(education, levels = c(1, 2, 3, 4, 5), 
                       labels = c("Less than 9th grade", 
                                  "9-11th grade", 
                                  "High school graduate/GED", 
                                  "Some college/AA degree", 
                                  "College graduate or above")))


## count the number of male and female, change from long format into wide format using `pivot_wider`.
education_gender_table <- sex_edu |>
  group_by(sex, education) |>
  summarize(count = n(), .groups = "drop") |>
  pivot_wider(names_from = education, values_from = count)

## make a table
kable(education_gender_table, caption = "Number of Male and Female in Each Education Category")
```
* Education level for male: 27 less than 9th grade, 35 9-11th grade, 56 high school graduate/GED
* Education level for female: 28 less than 9th grade, 23 9-11th grade, 59 high school graduate/GED

Visualization of the age distributions for men and women in each education category.
```{r}
## set x- axis education and y-axis as age and make a box plot. 
## box plot shows the median to better compare between male and female
sex_edu |>
ggplot(aes(x = education, y = age, fill = sex)) + 
  geom_boxplot(alpha = 0.5, position = position_dodge(width = 0.75)) +
  labs(
    title = "Age Distributions for Male and Female across Education Categories",
    x = "Education",
    y = "Age",
    fill = "Gender") +
  scale_fill_viridis_d() +
  theme_minimal()
```

* Male generally have higher median ages in "Less than 9th grade" and "High school graduate/GED"
* Female have higher median ages in "9-11th grade".


Aggregate and plot the total activity by age, comparing men and women across education levels
```{r}
## organize the data
total_activity <- sex_edu |>
  group_by(age, sex, education) |>
  summarize(total_activity = sum(age, sex, education, na.rm = TRUE))

## make a plot the total activity by age, comparing men and women across education levels
ggplot(total_activity, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) + 
  geom_smooth(se = FALSE, method = "loess") +  # Trend line for smooth visualization
  facet_wrap(~ education) + # generate 3 plots by education
  labs(
    title = "Total Daily Activity by Age, Gender, and Education Level",
    x = "Age",
    y = "Total Activity",
    color = "Gender") +
   scale_color_viridis_d() +
  theme_minimal()
```

* Total activity for both men and women increases with age across all education levels, with a notable rise starting around age 50. In the "Less than 9th grade" and "9-11th grade" categories, men tend to have higher activity levels than women. For "High school graduate/GED," women show more variability in total activity compared to men, possibly due to lifestyle differences.

Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. 
```{r}
## select columns that start with "min"
activity_data <- demo_accel |>
  select(sex, education, starts_with("min")) |>
  pivot_longer(cols = starts_with("min"), 
               names_to = "time", 
               values_to = "MIMS") |>
  mutate(time = as.numeric(gsub("min", "", time))) |> # Convert 'min' from dbl to numerical 
  drop_na(MIMS)

# Calculate mean MIMS per time, sex, and education
activity_summary <- activity_data |>
  group_by(time, sex, education) |>
  summarize(mean_MIMS = mean(MIMS, na.rm = TRUE), .groups = "drop") |>
  mutate(sex = factor(sex, labels = c("male", "female"))) 

## Plot 24-hour activity time courses by education level with color for sex
education_labels <- c("1" = "Less than 9th grade", 
                      "2" = "9-11th grade", 
                      "3" = "High school graduate/GED")

ggplot(activity_summary, aes(x = time, y = mean_MIMS, color = sex, group = sex)) +
  geom_line(alpha = 0.25) +
  geom_smooth(se = FALSE, method = "loess") +
  facet_wrap(~ education, labeller = labeller(education = education_labels)) +
  labs(
    title = "24-hour Activity Time Courses by Education Level",
    x = "Time of Day (minutes from midnight)",
    y = "Average MIMS",
    color = "Gender") +
  theme_minimal()
```
* Overall, across the three education levels, both males and females exhibit a similar trend: average activity is relatively low in the morning and evening, peaks mid-day, and then declines in the afternoon. In each plot, females consistently show higher average activity than males. Specifically, in the "High school graduate/GED" group, the peak activity period is broader than in the other two groups, suggesting that individuals with this education level sustain higher activity for a longer duration



